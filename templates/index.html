<!DOCTYPE html>
<html>
<head>
    <title>Time Series Visualization</title>
    <style>
        /* Add some basic styling */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input, select {
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Time Series Visualization</h2>
    
    <label for="storeNumber">Store Number:</label>
    <select id="storeNumber">
        <option value="1">1</option>
        <option value="2">2</option>
        <!-- Add options for store numbers 3 to 54 here -->
    </select>
    
    <label for="promotionWeightage">Promotion Weightage:</label>
    <input type="number" id="promotionWeightage" step="0.01" min="0" max="1">
    
    <label for="forecastDays">Number of Days to Forecast:</label>
    <input type="number" id="forecastDays" min="10" max="75">
    
    <label for="columnSelection">Select Column for Visualization:</label>
    <select id="columnSelection">
        <!-- Add options dynamically based on the generated dataframe -->
    </select>
    
    <button onclick="generateVisualization()">Generate Visualization</button>
    
    <div id="visualizationContainer"></div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        function generateVisualization() {
            var storeNumber = document.getElementById("storeNumber").value;
            var promotionWeightage = parseFloat(document.getElementById("promotionWeightage").value);
            var forecastDays = parseInt(document.getElementById("forecastDays").value);
            
            // Send AJAX request to retrieve the dataframe from Flask backend
            var xhr = new XMLHttpRequest();
            var url = "/generate_dataframe";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var dataframe = JSON.parse(xhr.responseText);
                    var columns = Object.keys(dataframe[0]);
                    
                    // Update column selection options
                    var columnSelection = document.getElementById("columnSelection");
                    columnSelection.innerHTML = "";
                    for (var i = 0; i < columns.length; i++) {
                        var option = document.createElement("option");
                        option.value = columns[i];
                        option.text = columns[i];
                        columnSelection.appendChild(option);
                    }
                    
                    // Generate visualization using D3.js
                    var selectedColumn = columnSelection.value;
                    var data = dataframe.map(function (row) {
                        return {
                            date: new Date(row.Date),
                            value: row[selectedColumn]
                        };
                    });
                    
                    // Clear previous visualization, if any
                    var container = document.getElementById("visualizationContainer");
                    container.innerHTML = "";
                    
                    // Create SVG container
                    var svg = d3.select("#visualizationContainer")
                        .append("svg")
                        .attr("width", 500)
                        .attr("height", 300);
                    
                    // Set up scales and axes
                    var xScale = d3.scaleTime()
                        .domain(d3.extent(data, function(d) { return d.date; }))
                        .range([50, 450]);
                    
                    var yScale = d3.scaleLinear()
                        .domain([0, d3.max(data, function(d) { return d.value; })])
                        .range([250, 50]);
                    
                    var xAxis = d3.axisBottom(xScale);
                    var yAxis = d3.axisLeft(yScale);
                    
                    // Add axes to the SVG
                    svg.append("g")
                        .attr("transform", "translate(0, 250)")
                        .call(xAxis);
                    
                    svg.append("g")
                        .attr("transform", "translate(50, 0)")
                        .call(yAxis);
                    
                    // Draw line chart
                    var line = d3.line()
                        .x(function(d) { return xScale(d.date); })
                        .y(function(d) { return yScale(d.value); });
                    
                    svg.append("path")
                        .datum(data)
                        .attr("fill", "none")
                        .attr("stroke", "steelblue")
                        .attr("stroke-width", 2)
                        .attr("d", line);
                }
            };
            
            // Send the request with the input data
            var requestData = {
                storeNumber: storeNumber,
                promotionWeightage: promotionWeightage,
                forecastDays: forecastDays
            };
            xhr.send(JSON.stringify(requestData));
        }
    </script>
</body>
</html>
